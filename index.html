<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>CSVã‹ã‚‰æ—¥éŸ“èª­ã¿ä¸Šã’</title>
<style>
 body { font-family: Arial; line-height: 1.8; padding: 20px; }
 button { padding: 8px 14px; margin: 4px 6px 4px 0; }
 textarea { width: 100%; height: 220px; font-size: 14px; }
 select { padding: 6px; }
</style>
</head>
<body>

<h2>CSV â†’ æ—¥æœ¬èª / éŸ“å›½èª èª­ã¿ä¸Šã’</h2>

<p>
  CSVé¸æŠï¼š
  <select id="csvSelect" onchange="loadCsv()">
    <option value="kankoku1.csv">kankoku1.csv</option>
    <option value="kankoku2.csv">kankoku2.csv</option>
  </select>
</p>

<p>
  <button onclick="startTTS()">â–¶ èª­ã¿ä¸Šã’é–‹å§‹ï¼ˆãƒ«ãƒ¼ãƒ—ï¼‰</button>
  <button onclick="stopTTS()">â¹ åœæ­¢</button>
  <button onclick="copyText()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
  <button onclick="clearText()">ğŸ§¹ æ¶ˆå»</button>
</p>

<div id="status">CSV èª­ã¿è¾¼ã¿ä¸­...</div>

<textarea id="csvBox"></textarea>

<script>
let idx = 0;
let looping = true;
const STORAGE_KEY = "csv_edit_text";

// ğŸ”¹ èµ·å‹•æ™‚ï¼šä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ ï¼‹ CSVèª­ã¿è¾¼ã¿
window.addEventListener("DOMContentLoaded", () => {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) {
    document.getElementById("csvBox").value = saved;
    document.getElementById("status").textContent = "ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ";
  }
  loadCsv();   // CSVã‚‚èª­ã¿è¾¼ã¿ï¼ˆå¾Œã‹ã‚‰ä¸Šæ›¸ãã•ã‚Œã‚‹æƒ³å®šï¼‰
});

// ğŸ”¹ ç·¨é›†å†…å®¹ã‚’è‡ªå‹•ä¿å­˜
document.getElementById("csvBox").addEventListener("input", e => {
  localStorage.setItem(STORAGE_KEY, e.target.value);
  document.getElementById("status").textContent = "è‡ªå‹•ä¿å­˜ã—ã¾ã—ãŸ";
});

async function loadCsv() {
  const status = document.getElementById("status");
  const box = document.getElementById("csvBox");
  const file = document.getElementById("csvSelect").value;

  try {
    const res = await fetch(file);
    if (!res.ok) {
      status.textContent = "ã‚¨ãƒ©ãƒ¼: HTTP " + res.status;
      return;
    }
    const text = await res.text();

    // ğŸ”¹ ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒç„¡ã„æ™‚ã®ã¿ CSV ã‚’é©ç”¨
    if (!localStorage.getItem(STORAGE_KEY)) {
      box.value = text.trim();
      status.textContent = `èª­ã¿è¾¼ã¿å®Œäº†ï¼š${file}`;
    }
  } catch (e) {
    status.textContent = "ã‚¨ãƒ©ãƒ¼: " + e.message;
  }
}

function speak(text, lang, cb){
  const u = new SpeechSynthesisUtterance(text);
  u.lang = lang;
  u.onend = cb;
  speechSynthesis.speak(u);
}

function startTTS(){
  speechSynthesis.cancel();
  idx = 0;
  looping = true;
  speakNext();
}

function speakNext(){
  const lines = document.getElementById("csvBox").value
    .split("\n")
    .map(l => l.split(","))
    .filter(x => x.length >= 3);

  if (!looping || !lines.length) return;
  if (idx >= lines.length) idx = 0;

  const jp = lines[idx][0];
  const ko = lines[idx][2];

  speak(jp, "ja-JP", () => {
    speak(ko, "ko-KR", () => {
      idx++;
      speakNext();
    });
  });
}

function stopTTS(){
  looping = false;
  speechSynthesis.cancel();
}

function copyText(){
  const text = document.getElementById("csvBox").value;
  navigator.clipboard?.writeText(text);
  document.getElementById("status").textContent = "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ";
}

function clearText(){
  document.getElementById("csvBox").value = "";
  localStorage.removeItem(STORAGE_KEY);
  document.getElementById("status").textContent = "æ¶ˆå»ã—ã¾ã—ãŸï¼ˆä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ï¼‰";
}
</script>

</body>
</html>
